name: Generate PlantUML Diagrams
on:
  workflow_dispatch:
  push:
    branches: [ main ] # Oder Ihr Standard-Branch-Name
    paths:
      - '**/*.puml'
      - '**/*.plantuml'
      - '**/*.md'
      - '*.md'

jobs:
  render:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Wichtig für den Schreibzugriff
    env:
      # Use a PAT (if configured) otherwise fall back to the default workflow token
      PLANTUML_TOKEN: ${{ secrets.PLANTUML_PAT || secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Holt die gesamte Historie für korrekte Merges
          persist-credentials: true

      - name: Extract PlantUML blocks from Markdown
        run: |
          python3 - <<'PY'
          import hashlib
          import re
          from pathlib import Path

          root = Path('.')
          out_dir = Path('diagrams/extracted')
          # Remove old extracted files to avoid stale diagrams
          if out_dir.exists():
            for p in out_dir.glob('*.puml'):
              p.unlink()
          out_dir.mkdir(parents=True, exist_ok=True)

          # Match fenced blocks: ```plantuml ... ```
          block_re = re.compile(r"```plantuml\s*\n(.*?)\n```", re.DOTALL | re.IGNORECASE)

          written = 0
          for md in root.rglob('*.md'):
            if '.git' in md.parts:
              continue
            text = md.read_text(encoding='utf-8', errors='ignore')
            blocks = block_re.findall(text)
            for idx, content in enumerate(blocks, start=1):
              content = content.strip() + "\n"
              h = hashlib.sha1((str(md) + str(idx) + content).encode('utf-8')).hexdigest()[:10]
              safe_stem = md.stem.replace(' ', '_')
              out = out_dir / f"{safe_stem}_{idx:02d}_{h}.puml"
              out.write_text(content, encoding='utf-8')
              written += 1

          print(f"Extracted {written} PlantUML blocks into {out_dir}")
          PY

      - name: Debug context
        run: |
          echo "actor=${{ github.actor }}"
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"

      - name: Manual run note
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "workflow_dispatch detected: grassedge/generate-plantuml-action expects push commit metadata and is skipped."
          echo "To render diagrams, push a change to a .md/.puml/.plantuml file."

      - name: Render PlantUML (all files)
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          mkdir -p diagrams/rendered
          # Render every .puml/.plantuml file (including diagrams/extracted generated from Markdown)
          mapfile -t FILES < <(find diagrams -type f \( -name "*.puml" -o -name "*.plantuml" \))
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No .puml/.plantuml files found under diagrams/"
            exit 0
          fi
          # Convert to absolute paths inside the container
          ARGS=()
          for f in "${FILES[@]}"; do
            ARGS+=("/work/$f")
          done
          docker run --rm -v "$PWD:/work" plantuml/plantuml -tsvg -o /work/diagrams/rendered "${ARGS[@]}"

      - name: Auto-Commit rendered diagrams
        if: github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        env:
          GITHUB_TOKEN: ${{ env.PLANTUML_TOKEN }}
        with:
          commit_message: "chore: render plantuml diagrams"
          file_pattern: |
            diagrams/**/*
